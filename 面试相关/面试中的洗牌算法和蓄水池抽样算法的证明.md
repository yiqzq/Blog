# 面试中的洗牌算法和蓄水池抽样算法的证明

[toc]

## 洗牌算法

题目：有一副斗地主的扑克牌，设计一个洗牌算法。

问题很简单，但问题的关键在于要设计一个公平的算法，使得**每一个位置都能等概率地放置每个元素**。

由于之前没有研究过这个问题，面试被问到就很尴尬，所以这里记录一下优秀的洗牌算法。

**一个最简单的方法**

1. 有n张牌，每次从中任意的取出一张
2. 还剩下n-1张牌，然后从这n-1张牌中随机选择一张
3. 。。。
4. 直至全部去完

这个算法是公平的，简单证明一下。

**证明**

有n张牌，那么第一个位置上的牌可以选择n张，那么也就是每张牌在第一个位置的概率是$$\frac{1}{n}$$

现在剩余n-1张牌，在这n-1张牌中选择一张放在第二个位置的概率是$$\frac{1}{n-1}$$，但是实际概率应该还要乘在第一次中没有被选中的概率，也就是$$\frac{1}{n-1}*\frac{n-1}{n}=\frac{1}{n}$$

现在剩余n-2张牌，在这n-2张牌中选择一张放在第三个位置的概率是$$\frac{1}{n-2}$$，但是实际概率应该还要乘在第一次中没有被选中的概率和第二次没有被选中的概率，也就是$$\frac{n-1}{n}*\frac{n-2}{n-1}*\frac{1}{n-2}=\frac{1}{n}$$

。。。剩下的一次递推，结果都是一样的。

但是这个算法有个致命的缺陷就是时间复杂度太高，因为在具体的代码实现中，你是需要进行一个删除操作的，这个复杂度是$O（n）$的，也就是说这个朴素的算法的复杂度是$O (n^2)$。

**优化算法Knuth-Durstenfeld Shhuffle**

这个算法的核心思想就是从最后开始，比如当前在位置$i$，那么就随机一个在$i$之前的下标$index$，交换$index$和$i$的元素，然后向前推进一格。

```java
for(int i = n - 1; i >= 0 ; i -- )
	swap(arr[i], arr[rand() % (i + 1)])
```

这个算法也是公平的，但是将时间复杂度一下子缩小到了$O（n）$

**证明**

还是假设有n张牌，我们现在随机一个下标index，然后交换index和n两个下标的牌，那么随机选择的index可能是n张牌中的任何一张，那么也就是说任何一张牌放在最后的位置n的概率是$\frac{1}{n}$

确定了最后一个位置的牌之后，现在确定第n-1个位置的牌，现在还剩下n-1个位置没有牌，从n-1张牌随机一张，选中的概率是$\frac{1}{n-1}$,将这张牌放在n-1的位置的概率还要乘上没有在第一轮中被选中的概率，也就是$$\frac{1}{n-1}*\frac{n-1}{n}=\frac{1}{n}$$

接下来同理，可以看到其实原理和前面的朴素算法差不多，只是这个更加巧妙，但是也能证明这是一个公平的算法。

## 蓄水池抽样算法

题目： 从n个元素中随机等概率取出k个元素，n长度未知。

先说算法，先选中第1到k个元素，作为被选中的元素。然后依次对第k+1至第N个元素做如下操作：
每个元素都有$\frac{k}{i}$的概率被选中，然后等概率的（也就是$\frac{1}{k}$）选择一个已经被选中的元素替换。其中$i$是元素的序号。

**证明**

如果n<=K，那么就很明显直接选择前n个即可，每个的概率都是1

如果n>k，那就先选择前k个

接下来如果$i=k+1$，那么第i个被选中的概率是$\frac{k}{k+1}$，那么对于前k个，都是默认被选中的，接下来每一个都会有$\frac{1}{k}$的概率被替换，也就是有$1-\frac{k}{k+1}*\frac{1}{k}=1-\frac{1}{k+1}=\frac{k}{k+1}$的概率保留，很明显成立，每个元素都有相等的概率被选中。

如果j=i+1，那么对于对于第j个元素，有$\frac{k}{i+1}$的概率被选中，然后对于前i个元素，前面已经证明过了有$\frac{k}{i}$的概率被选中，现在只需要计算出保留的概率。

保留的概率=1- 被替换的概率=1$-\frac{k}{i+1}*\frac{1}{k}=1-\frac{1}{i+1}=\frac{i}{i+1}$

所以前i个元素被选中的概率是$\frac{k}{i}*\frac{i}{i+1}=\frac{k}{i+1}$

以此类推，用数学归纳法可以证明算法的正确性。



## 参考内容

[【算法杂谈4】神一样的随机算法](https://zhuanlan.zhihu.com/p/73147939)

[三种洗牌算法shuffle](https://blog.csdn.net/qq_26399665/article/details/79831490)